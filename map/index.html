<!DOCTYPE html>
<html>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type">
    <title>Leaflet d3.js Hexbin Demo</title>

    <!-- based on:      https://github.com/Asymmetrik/leaflet-d3
         specifically:  http://jsfiddle.net/acjnbu8t/

         `lib/leaflet-d3.js` was modified slightly
                Play with the radius variable to change hex size.

                Change the color scheme and scaling by looking for
                `MODIFIED` in `lib/leaflet-d3.js`.
    -->

    <link href="map.css" rel="stylesheet" type="text/css">
    <link href="lib/leaflet.css" rel="stylesheet" type="text/css">
    <script src="lib/jquery-2.1.3.min.js"   type="text/javascript"></script>
    <script src="lib/leaflet.js"            type="text/javascript"></script>
    <script src="lib/underscore-min.js"     type="text/javascript"></script>

    <script src="lib/d3.js"                 type="text/javascript"></script>
    <script src="lib/hexbin.js"             type="text/javascript"></script>
    <script src="lib/leaflet-d3.js"         type="text/javascript"></script>
    <script src="lib/hexmap.js"             type="text/javascript"></script>
</head>

<body>
    <div id="map" class="full">uaie</div>
    <div id="sidebar" class="menu">
        <label for="timerange">Zeitraum</label>
        <input id="timerange" type="range" name="timerange">
        <label for="showoffline">Offline Nodes</label>
        <input id="showoffline" type="checkbox" name="offline">
    </div>

    <script type="text/javascript">
        $(document).ready(function(){
            var hexmap = new HexMap();
            console.log("HexMap", hexmap);
            hexmap.getDataBetweenDates(new Date(2016, 10, 1, 0, 0, 0, 0), new Date())
        });


        function initializeMap(center, startZoom, maxZoom) {
            var osmUrl    = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap<\/a> contributors',
                osmLayer  = L.tileLayer(osmUrl, {maxZoom: maxZoom, attribution: osmAttrib});
    
            var map = new L.Map('map', {layers: [osmLayer], center: center, zoom: startZoom});
    
            return [ map, osmLayer ];
        }

        function addHexbinLayer(map, data, radius) { 
            var options = {
                radius: radius,
                opacity: 0.5,
                duration: 200,
                lng: function(d){
                    return d[0];
                },
                lat: function(d){
                    return d[1];
                },
                value: function(d){
                    var sum = 0, sum2 = 0;
                    d.forEach(function (datum) {
                            sum += datum.o[2];
                            //sum += datum.o[2] / datum.o[3];
                            //sum2 += datum.o[3];
                        });
                    var mean = sum / d.length;
                    //var mean = sum / d.length * sum2;
                    return mean;
                }//,
                //valueFloor: _.min(vals), // I think these are currently ignored
                //valueCeil:  _.max(vals)
            };
        
            var hexLayer = L.hexbinLayer(options).addTo(map)
            hexLayer.data(data);
            return hexLayer;
        }

        var coords_aachen = [ 51.549775, 9.9297669 ];

        var init = initializeMap(coords_aachen, 15, 19);
        map = init[0];
        osm = init[1];

        //L.control.layers({ "Open Street Maps": osm }, { "Freifunk RSSI Hexbin": hexbinLayer }).addTo(map);

    </script>
</body>
</html>
