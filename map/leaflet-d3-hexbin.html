<!DOCTYPE html>
<html>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type">
    <title>Leaflet d3.js Hexbin Demo</title>

    <!-- based on:      https://github.com/Asymmetrik/leaflet-d3
         specifically:  http://jsfiddle.net/acjnbu8t/

         `lib/leaflet-d3.js` was modified slightly



                Play with the radius variable to change hex size.

                Change the color scheme and scaling by looking for
                `MODIFIED` in `lib/leaflet-d3.js`.

        Data conversion:
                Install csvfix: https://code.google.com/p/csvfix/
                Example command:
                    csvfix printf -f 3,2,9 -fmt "[ %-10s, %-10s, %s ]," wifilog.csv > newdata.js

                You still need to modify the first and last line(s)!
    -->

    <script src="lib/jquery-2.1.3.min.js"   type="text/javascript"></script>
    <script src="lib/underscore-min.js"     type="text/javascript"></script>
    <script src="lib/papaparse.min.js"      type="text/javascript"></script>

    <script src="lib/d3.js"                 type="text/javascript"></script>
    <script src="lib/hexbin.js"             type="text/javascript"></script>
    <script src="lib/leaflet.js"            type="text/javascript"></script>
    <script src="lib/leaflet-d3.js"         type="text/javascript"></script>

    <link href="lib/leaflet.css" rel="stylesheet" type="text/css">
    <style type="text/css">
        .hexbin-hexagon {
          stroke: #000;
          stroke-width: 1px;
        }
    </style>
</head>

<body>
    <div id="map" style='width: "100%"; height: 800px; border: 1px solid #ccc'></div>
    <input type="file" id="csv-file" name="files"/>

    <script type="text/javascript">//<![CDATA[ 
        function handleFileSelect(evt) {
            var file = evt.target.files[0];

            console.log(file);

            var reader = new FileReader();

            reader.onload = function(e) {
                //console.log("reader.result", reader.result);
                var data = JSON.parse(reader.result);
                console.log("data", data);

                var lngs = [], lats = [], vals = [], accuracy = [], count = 0;

                for (var i = data.values.length - 1; i >= 0; i--) {
                    if (data.values[i].accuracy > 10) {
                        continue;
                    }
                    lngs[count] = data.values[i].longitude;
                    lats[count] = data.values[i].latitude;
                    vals[count] = data.values[i].rssi;
                    accuracy[count] = data.values[i].accuracy;
                    //console.log("lngs["+i+"]", lngs[i]);
                    count++;
                }

                var hexbinLayer = addHexbinLayer(map, _.zip(lngs, lats, vals, accuracy), 15);

                console.log("_.min(lats)", _.min(lats));
                console.log("_.max(lats)", _.max(lats));
                console.log("_.min(lngs)", _.min(lngs));
                console.log("_.max(lngs)", _.max(lngs));
                //map.panTo([ (_.min(lats) + _.max(lats))/2, (_.min(lngs) + _.max(lngs))/2 ]);

            }

            reader.readAsText(file);
        }
 
        $(document).ready(function(){
            $("#csv-file").change(handleFileSelect);
        });


        function initializeMap(center, startZoom, maxZoom) {
            var osmUrl    = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap<\/a> contributors',
                osmLayer  = L.tileLayer(osmUrl, {maxZoom: maxZoom, attribution: osmAttrib});
    
            var map = new L.Map('map', {layers: [osmLayer], center: center, zoom: startZoom});
    
            return [ map, osmLayer ];
        }

        function addHexbinLayer(map, data, radius) { 
            var options = {
                radius: radius,
                opacity: 0.5,
                duration: 200,
                lng: function(d){
                    return d[0];
                },
                lat: function(d){
                    return d[1];
                },
                value: function(d){
                    var sum = 0, sum2 = 0;
                    d.forEach(function (datum) {
                            sum += datum.o[2] / datum.o[3];
                            sum2 += datum.o[3];
                        });
                    var mean = sum / d.length * sum2;
                    return mean;
                }//,
                //valueFloor: _.min(vals), // I think these are currently ignored
                //valueCeil:  _.max(vals)
            };
        
            var hexLayer = L.hexbinLayer(options).addTo(map)
            hexLayer.data(data);
            return hexLayer;
        }

        var coords_aachen = [ 51.549775, 9.9297669 ];

        var init = initializeMap(coords_aachen, 15, 19);
        map = init[0];
        osm = init[1];

        //L.control.layers({ "Open Street Maps": osm }, { "Freifunk RSSI Hexbin": hexbinLayer }).addTo(map);

    //]]></script>
</body>
</html>
